# Evangelos Kontopantelis, David Springate, David Reeves, Darren M Ashcroft, Jose M Valderas, Tim Doran, 2024.

import sys, csv, re

codes = [{"code":"3018","system":"gprdproduct"},{"code":"13181","system":"gprdproduct"},{"code":"6796","system":"gprdproduct"},{"code":"1741","system":"gprdproduct"},{"code":"26616","system":"gprdproduct"},{"code":"2159","system":"gprdproduct"},{"code":"37791","system":"gprdproduct"},{"code":"960","system":"gprdproduct"},{"code":"23961","system":"gprdproduct"},{"code":"947","system":"gprdproduct"},{"code":"907","system":"gprdproduct"},{"code":"11732","system":"gprdproduct"},{"code":"7013","system":"gprdproduct"},{"code":"5889","system":"gprdproduct"},{"code":"30240","system":"gprdproduct"},{"code":"6325","system":"gprdproduct"},{"code":"2335","system":"gprdproduct"},{"code":"7602","system":"gprdproduct"},{"code":"2892","system":"gprdproduct"},{"code":"4688","system":"gprdproduct"},{"code":"4365","system":"gprdproduct"},{"code":"3306","system":"gprdproduct"},{"code":"8111","system":"gprdproduct"},{"code":"18848","system":"gprdproduct"},{"code":"27679","system":"gprdproduct"},{"code":"5558","system":"gprdproduct"},{"code":"898","system":"gprdproduct"},{"code":"35602","system":"gprdproduct"},{"code":"1236","system":"gprdproduct"},{"code":"9921","system":"gprdproduct"},{"code":"11410","system":"gprdproduct"},{"code":"13307","system":"gprdproduct"},{"code":"6719","system":"gprdproduct"},{"code":"911","system":"gprdproduct"},{"code":"34029","system":"gprdproduct"},{"code":"2893","system":"gprdproduct"},{"code":"35862","system":"gprdproduct"},{"code":"5170","system":"gprdproduct"},{"code":"896","system":"gprdproduct"},{"code":"1680","system":"gprdproduct"},{"code":"7891","system":"gprdproduct"},{"code":"1269","system":"gprdproduct"},{"code":"19121","system":"gprdproduct"},{"code":"34702","system":"gprdproduct"},{"code":"1727","system":"gprdproduct"},{"code":"17670","system":"gprdproduct"},{"code":"16054","system":"gprdproduct"},{"code":"28640","system":"gprdproduct"},{"code":"2148","system":"gprdproduct"},{"code":"1411","system":"gprdproduct"},{"code":"33849","system":"gprdproduct"},{"code":"5185","system":"gprdproduct"},{"code":"956","system":"gprdproduct"},{"code":"33258","system":"gprdproduct"},{"code":"3119","system":"gprdproduct"},{"code":"4499","system":"gprdproduct"},{"code":"33373","system":"gprdproduct"},{"code":"40655","system":"gprdproduct"},{"code":"3220","system":"gprdproduct"},{"code":"9270","system":"gprdproduct"},{"code":"14524","system":"gprdproduct"},{"code":"3163","system":"gprdproduct"},{"code":"31774","system":"gprdproduct"},{"code":"35631","system":"gprdproduct"},{"code":"17465","system":"gprdproduct"},{"code":"23709","system":"gprdproduct"},{"code":"957","system":"gprdproduct"},{"code":"31","system":"gprdproduct"},{"code":"33588","system":"gprdproduct"},{"code":"9599","system":"gprdproduct"},{"code":"1551","system":"gprdproduct"},{"code":"16584","system":"gprdproduct"},{"code":"17","system":"gprdproduct"},{"code":"8635","system":"gprdproduct"},{"code":"5822","system":"gprdproduct"},{"code":"4413","system":"gprdproduct"},{"code":"1697","system":"gprdproduct"},{"code":"454","system":"gprdproduct"},{"code":"4803","system":"gprdproduct"},{"code":"27505","system":"gprdproduct"},{"code":"1885","system":"gprdproduct"},{"code":"3743","system":"gprdproduct"},{"code":"7788","system":"gprdproduct"},{"code":"9711","system":"gprdproduct"},{"code":"9651","system":"gprdproduct"},{"code":"35510","system":"gprdproduct"},{"code":"4665","system":"gprdproduct"},{"code":"14700","system":"gprdproduct"},{"code":"17185","system":"gprdproduct"},{"code":"6938","system":"gprdproduct"},{"code":"5740","system":"gprdproduct"},{"code":"32874","system":"gprdproduct"},{"code":"8","system":"gprdproduct"},{"code":"35724","system":"gprdproduct"},{"code":"14590","system":"gprdproduct"},{"code":"1412","system":"gprdproduct"},{"code":"2440","system":"gprdproduct"},{"code":"14483","system":"gprdproduct"},{"code":"7948","system":"gprdproduct"},{"code":"908","system":"gprdproduct"},{"code":"13037","system":"gprdproduct"},{"code":"1950","system":"gprdproduct"},{"code":"30204","system":"gprdproduct"},{"code":"41412","system":"gprdproduct"},{"code":"9577","system":"gprdproduct"},{"code":"34739","system":"gprdproduct"},{"code":"3556","system":"gprdproduct"},{"code":"895","system":"gprdproduct"},{"code":"5522","system":"gprdproduct"},{"code":"34794","system":"gprdproduct"},{"code":"3786","system":"gprdproduct"},{"code":"6616","system":"gprdproduct"},{"code":"14525","system":"gprdproduct"},{"code":"40177","system":"gprdproduct"},{"code":"2224","system":"gprdproduct"},{"code":"7711","system":"gprdproduct"},{"code":"4545","system":"gprdproduct"},{"code":"5143","system":"gprdproduct"},{"code":"1794","system":"gprdproduct"},{"code":"14757","system":"gprdproduct"},{"code":"1259","system":"gprdproduct"},{"code":"34134","system":"gprdproduct"},{"code":"5516","system":"gprdproduct"},{"code":"19031","system":"gprdproduct"},{"code":"2600","system":"gprdproduct"},{"code":"1552","system":"gprdproduct"},{"code":"4131","system":"gprdproduct"},{"code":"10321","system":"gprdproduct"},{"code":"16151","system":"gprdproduct"},{"code":"7653","system":"gprdproduct"},{"code":"22430","system":"gprdproduct"},{"code":"2951","system":"gprdproduct"},{"code":"2851","system":"gprdproduct"},{"code":"1424","system":"gprdproduct"},{"code":"3150","system":"gprdproduct"},{"code":"16158","system":"gprdproduct"},{"code":"34310","system":"gprdproduct"},{"code":"746","system":"gprdproduct"},{"code":"32050","system":"gprdproduct"},{"code":"2978","system":"gprdproduct"},{"code":"1406","system":"gprdproduct"},{"code":"2229","system":"gprdproduct"},{"code":"18537","system":"gprdproduct"},{"code":"5551","system":"gprdproduct"},{"code":"34428","system":"gprdproduct"},{"code":"6780","system":"gprdproduct"},{"code":"6911","system":"gprdproduct"},{"code":"6081","system":"gprdproduct"},{"code":"5992","system":"gprdproduct"},{"code":"4601","system":"gprdproduct"},{"code":"6746","system":"gprdproduct"},{"code":"1518","system":"gprdproduct"},{"code":"13290","system":"gprdproduct"},{"code":"7356","system":"gprdproduct"},{"code":"35000","system":"gprdproduct"},{"code":"12994","system":"gprdproduct"},{"code":"6758","system":"gprdproduct"},{"code":"30229","system":"gprdproduct"},{"code":"4497","system":"gprdproduct"},{"code":"19389","system":"gprdproduct"},{"code":"10102","system":"gprdproduct"},{"code":"11198","system":"gprdproduct"},{"code":"9477","system":"gprdproduct"},{"code":"2125","system":"gprdproduct"},{"code":"958","system":"gprdproduct"},{"code":"11497","system":"gprdproduct"},{"code":"1952","system":"gprdproduct"},{"code":"30649","system":"gprdproduct"},{"code":"2282","system":"gprdproduct"},{"code":"2722","system":"gprdproduct"},{"code":"19401","system":"gprdproduct"},{"code":"99","system":"gprdproduct"},{"code":"18140","system":"gprdproduct"},{"code":"28761","system":"gprdproduct"},{"code":"1537","system":"gprdproduct"},{"code":"15706","system":"gprdproduct"},{"code":"16148","system":"gprdproduct"},{"code":"1734","system":"gprdproduct"},{"code":"14294","system":"gprdproduct"},{"code":"25204","system":"gprdproduct"},{"code":"13815","system":"gprdproduct"},{"code":"5172","system":"gprdproduct"},{"code":"7935","system":"gprdproduct"},{"code":"883","system":"gprdproduct"},{"code":"10090","system":"gprdproduct"},{"code":"29325","system":"gprdproduct"},{"code":"17654","system":"gprdproduct"},{"code":"2160","system":"gprdproduct"},{"code":"23567","system":"gprdproduct"},{"code":"2092","system":"gprdproduct"},{"code":"28577","system":"gprdproduct"},{"code":"2655","system":"gprdproduct"},{"code":"13040","system":"gprdproduct"},{"code":"9164","system":"gprdproduct"},{"code":"2850","system":"gprdproduct"},{"code":"6512","system":"gprdproduct"},{"code":"9571","system":"gprdproduct"},{"code":"1619","system":"gprdproduct"},{"code":"30118","system":"gprdproduct"},{"code":"1975","system":"gprdproduct"},{"code":"21005","system":"gprdproduct"},{"code":"7638","system":"gprdproduct"},{"code":"5309","system":"gprdproduct"},{"code":"1093","system":"gprdproduct"},{"code":"18394","system":"gprdproduct"},{"code":"18299","system":"gprdproduct"},{"code":"4842","system":"gprdproduct"},{"code":"8433","system":"gprdproduct"},{"code":"34619","system":"gprdproduct"},{"code":"20825","system":"gprdproduct"},{"code":"1100","system":"gprdproduct"},{"code":"14321","system":"gprdproduct"},{"code":"3297","system":"gprdproduct"},{"code":"1725","system":"gprdproduct"},{"code":"41269","system":"gprdproduct"},{"code":"5804","system":"gprdproduct"},{"code":"34315","system":"gprdproduct"},{"code":"882","system":"gprdproduct"},{"code":"3989","system":"gprdproduct"},{"code":"26063","system":"gprdproduct"},{"code":"34995","system":"gprdproduct"},{"code":"5521","system":"gprdproduct"},{"code":"31933","system":"gprdproduct"},{"code":"3570","system":"gprdproduct"},{"code":"34859","system":"gprdproduct"},{"code":"33817","system":"gprdproduct"},{"code":"3927","system":"gprdproduct"},{"code":"7140","system":"gprdproduct"},{"code":"24898","system":"gprdproduct"},{"code":"1628","system":"gprdproduct"},{"code":"11618","system":"gprdproduct"},{"code":"3993","system":"gprdproduct"},{"code":"5864","system":"gprdproduct"},{"code":"33089","system":"gprdproduct"},{"code":"18421","system":"gprdproduct"},{"code":"5580","system":"gprdproduct"},{"code":"1426","system":"gprdproduct"},{"code":"13038","system":"gprdproduct"},{"code":"7964","system":"gprdproduct"},{"code":"19376","system":"gprdproduct"},{"code":"942","system":"gprdproduct"},{"code":"30230","system":"gprdproduct"},{"code":"1243","system":"gprdproduct"},{"code":"14736","system":"gprdproduct"},{"code":"1620","system":"gprdproduct"},{"code":"909","system":"gprdproduct"},{"code":"1951","system":"gprdproduct"},{"code":"28508","system":"gprdproduct"},{"code":"534","system":"gprdproduct"},{"code":"30238","system":"gprdproduct"},{"code":"16577","system":"gprdproduct"},{"code":"15326","system":"gprdproduct"},{"code":"10218","system":"gprdproduct"},{"code":"5753","system":"gprdproduct"},{"code":"5683","system":"gprdproduct"},{"code":"1409","system":"gprdproduct"},{"code":"7017","system":"gprdproduct"},{"code":"1882","system":"gprdproduct"},{"code":"1642","system":"gprdproduct"},{"code":"1258","system":"gprdproduct"},{"code":"14567","system":"gprdproduct"},{"code":"35014","system":"gprdproduct"},{"code":"12909","system":"gprdproduct"},{"code":"34919","system":"gprdproduct"},{"code":"46157","system":"gprdproduct"},{"code":"2992","system":"gprdproduct"},{"code":"6050","system":"gprdproduct"},{"code":"35522","system":"gprdproduct"},{"code":"3075","system":"gprdproduct"},{"code":"23741","system":"gprdproduct"},{"code":"13996","system":"gprdproduct"},{"code":"4759","system":"gprdproduct"},{"code":"3947","system":"gprdproduct"},{"code":"13757","system":"gprdproduct"},{"code":"28073","system":"gprdproduct"},{"code":"4926","system":"gprdproduct"},{"code":"21859","system":"gprdproduct"},{"code":"38","system":"gprdproduct"},{"code":"959","system":"gprdproduct"},{"code":"5223","system":"gprdproduct"},{"code":"1242","system":"gprdproduct"},{"code":"13273","system":"gprdproduct"},{"code":"14561","system":"gprdproduct"},{"code":"6522","system":"gprdproduct"},{"code":"719","system":"gprdproduct"},{"code":"9233","system":"gprdproduct"},{"code":"12808","system":"gprdproduct"},{"code":"21482","system":"gprdproduct"},{"code":"1415","system":"gprdproduct"},{"code":"1698","system":"gprdproduct"},{"code":"5885","system":"gprdproduct"},{"code":"35011","system":"gprdproduct"},{"code":"27188","system":"gprdproduct"},{"code":"3443","system":"gprdproduct"},{"code":"1861","system":"gprdproduct"},{"code":"2020","system":"gprdproduct"},{"code":"4268","system":"gprdproduct"},{"code":"3546","system":"gprdproduct"},{"code":"5942","system":"gprdproduct"},{"code":"18456","system":"gprdproduct"},{"code":"34311","system":"gprdproduct"},{"code":"30210","system":"gprdproduct"},{"code":"6772","system":"gprdproduct"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('asthma-drugs-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["asthma-drugs-160microgram---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["asthma-drugs-160microgram---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["asthma-drugs-160microgram---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
